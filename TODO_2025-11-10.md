# TODO: 2025年11月10日

## 検証テスト

### 1. 今日の修正内容の動作確認
```bash
node bin/othello.js --url "https://hotel-example-site.takeyaqa.dev/ja/reserve.html?plan-id=0" --interactive --iterations 2 --llm openai --test-aspects C:\workspace\Othello\docs\test-matrix.csv
```

**確認項目:**
- [ ] Planner/Generatorファイルが重複せず保存される
  - ファイル名に `aspect-XX-specific` が含まれているか
  - 通常実行と対話モード選択で別ファイルになっているか
- [ ] GeneratorのJSON parseエラーが解消される
  - test_case_idが正しく保持される（TC010-02 → TC0102にならない）
  - デバッグログでLLMレスポンスが確認できる
  - maxTokens増加でレスポンス切断が防止される

---

## バグ修正1: レポートHTMLの失敗テスト詳細

### 問題
レポートHTMLで失敗したテストの詳細（エラーメッセージ）を記載すると、そこまでしか記述されない。

### 原因調査
`src/agents/othello-reporter.js` Line 460-485:
イテレーション詳細のテーブルに**エラー列がない**ため、失敗理由が表示されない。

### 修正内容
1. イテレーション詳細テーブルにエラー列を追加
2. 失敗したテストケースのエラー情報を表示

### 修正箇所
```javascript
// src/agents/othello-reporter.js Line 460-485
<table style="margin-top: 10px;">
  <thead>
    <tr>
      <th>テストケースID</th>
      <th>観点</th>
      <th>結果</th>
      <th>実行時間</th>
      <th>エラー</th>  // ← 追加
    </tr>
  </thead>
  <tbody>
    ${iter.executionResults.map(result => `
    <tr>
      <td>${result.test_case_id}</td>
      <td>${result.aspect_no || '-'}</td>
      <td>
        ${result.success 
          ? '<span class="badge badge-success">✅ 成功</span>' 
          : '<span class="badge badge-danger">❌ 失敗</span>'}
      </td>
      <td>${result.duration_ms ? this.formatDuration(result.duration_ms) : '-'}</td>
      <td>${result.error || '-'}</td>  // ← 追加
    </tr>
    `).join('')}
  </tbody>
</table>
```

### テスト方法
1. わざと失敗するテストを実行
2. HTMLレポートを開く
3. イテレーション詳細でエラー情報が表示されることを確認

---

## 機能追加: 対話モードでの観点要約表示

### 要望
対話モードでイテレーション1実行後にユーザーに次のテストを提示する際、
テスト観点を要約して簡単にテストの内容を提示したい。

### 現在の表示
```
[1] 観点10のテスト (P1)
    理由: まだテストされていない観点です
```

### 改善後の表示（案）
```
[1] 観点10のテスト (P1)
    内容: 入力値の妥当性検証（日付・文字種チェック）
    理由: まだテストされていない観点です
```

### 実装方針
1. **test-aspectsファイル（CSV）に要約列を追加**
   - 既存: `No., 観点, 優先度, テスト内容`
   - 追加: `No., 観点, 優先度, テスト内容, 要約`

2. **Analyzerで観点情報を取得**
   - `othello-analyzer.js`で観点番号から要約を取得
   - recommendationオブジェクトに`summary`フィールドを追加

3. **Orchestratorで要約を表示**
   - `showRecommendations()`メソッドで要約を表示

### 修正箇所

#### 1. CSVファイル更新（例）
```csv
No.,観点,優先度,テスト内容,要約
1,画面表示,P0,予約入力画面が正しく表示される,画面表示の基本確認
10,入力値検証,P0,日付・文字種の妥当性チェック,入力値の妥当性検証
```

#### 2. Analyzer修正
```javascript
// src/agents/othello-analyzer.js
async generateRecommendations(executionResults, currentCoverage) {
  // ...
  
  // 観点情報を取得して要約を追加
  const aspectInfo = this.getAspectInfo(aspectId);
  
  recommendations.push({
    type: 'specific',
    aspectId: aspectId,
    title: `観点${aspectId}のテスト`,
    summary: aspectInfo?.summary || '詳細情報なし',  // ← 追加
    reason: reason,
    priority: priority
  });
}

getAspectInfo(aspectId) {
  // test-aspectsから観点情報を取得
  // CSVパース結果から該当行を検索
  const aspect = this.testAspects.find(a => a.no === aspectId);
  return aspect ? {
    no: aspect.no,
    name: aspect.name,
    priority: aspect.priority,
    description: aspect.description,
    summary: aspect.summary || aspect.name  // 要約があれば使用、なければ観点名
  } : null;
}
```

#### 3. Orchestrator修正
```javascript
// src/orchestrator.js Line 383-395
async showRecommendations(recommendations) {
  console.log('\n🎯 次にやるべきテスト:\n');
  recommendations.forEach((rec, index) => {
    console.log(`[${index + 1}] ${rec.title} (${rec.priority})`);
    if (rec.summary) {  // ← 追加
      console.log(`    内容: ${rec.summary}`);
    }
    console.log(`    理由: ${rec.reason}\n`);
  });
  
  console.log('[0] 終了');
  console.log('[Enter] 次のイテレーションを続行\n');
}
```

### テスト方法
1. CSVに要約列を追加
2. 対話モードで実行
3. 推奨テスト表示で要約が出ることを確認

---

## バグ修正2: CSV優先度列が参照されていない

### 問題
`test-matrix.csv`の「優先度」列（P0, P1, P2, P3）が読み込まれていない。

### 原因
`othello-planner.js`の`loadTestAspects()`メソッドで優先度列を読み込んでいなかった。

### 修正内容（既に実施済み）
1. Plannerで優先度列を読み込むように修正 ✅
2. Analyzerで未カバー観点の推奨時に優先度を使用（要実装）

### 残課題
- Analyzerの`generateRecommendations()`で観点の優先度を使って推奨順を決める
- 現在は全て`'High'`固定になっている

---

## バグ修正0 (CRITICAL): CSV Parser が複数行フィールドに未対応

### 問題 **（最優先で修正必要）**
`csv-parser.js`が複数行にまたがるフィールド（クォート内の改行）を正しくパースできていない。

### 現状
```
"考慮すべき仕様の具体例（テスト対象固有）","・項目1
・項目2
・項目3","狙うバグ","P0"
```
このようなCSVで、2行目以降が新しい行として解釈され、優先度が読み取れない。

### 影響
- **優先度列が全て空文字列になる** → P0/P1/P2/P3によるソートが機能しない
- テストケースがCSV順（観点番号順）に生成される → 要件違反

### 解決策
1. **短期** (30分): CSVファイルを修正して改行を削除
   - `sed` or PowerShellで改行を空白に置換
   - または、Excelで開いて「名前を付けて保存」

2. **中期** (60分): csv-parser.js を修正
   - クォート内の改行を正しく処理
   - RFC 4180準拠のパーサーに改良

**今日は短期対応で進める！**

---

## 実行順序

1. **🔥 CSV修正 (CRITICAL)** （30分）
   - test-matrix.csvの複数行フィールドを修正
   - 優先度が正しく読み取れることを確認

2. **検証テスト** （30分）
   - 今日の修正が正しく動作するか確認
   - 優先度順（P0→P1→P2→P3）にテスト生成されることを確認

3. **バグ修正1: レポートHTML** （15分）
   - レポートHTMLのエラー列追加
   - 簡単な修正なのでサクッと

4. **バグ修正2: 優先度対応** （30分）
   - Analyzerで観点優先度を使用
   - P0 > P1 > P2 > P3 の順で推奨

5. **機能追加: 観点要約** （45分）
   - CSV更新、Analyzer修正、Orchestrator修正
   - テストケース実行で動作確認

**所要時間: 約2.5時間**

---

## 💾 今日のコミット履歴

```
b0d0daf - Generator: JSON parseエラーと不正なtest_case_id生成を修正
693e420 - Fix: 対話モードでPlanner/Generator生成物ファイルが上書きされる問題を修正
29e9e02 - Fix: Screenshot機能のMCPセキュリティ制限に対応
5ead24d - Fix: 対話モード関連の複数バグを修正（観点選択、イテレーション履歴）
c6f6653 - Update: READMEをホテル特有ではなく汎用的な説明に変更
```

**未プッシュ: 5コミット**
明日の作業後にまとめてpushするか検討。
