# Othello - Playwright E2Eテスト自動化ツール 要件定義書（Phase 9版）

**システム名**: Othello  
**バージョン**: 2.0  
**作成日**: 2025年10月23日  
**更新日**: 2025年10月28日  
**対象フェーズ**: Phase 9（完全自動化版）  
**実装状況**: Othello-Planner 実装完了（2025年10月27日）

---

## 📋 目次

1. [プロジェクト概要](#1-プロジェクト概要)
2. [機能要件](#2-機能要件)
3. [非機能要件](#3-非機能要件)
4. [システム要件](#4-システム要件)
5. [制約事項](#5-制約事項)
6. [実装ステータス](#6-実装ステータス)

---

## 1. プロジェクト概要

### 1.1 システム名の由来

「Othello（オセロ）」という名前は、以下の意味を込めています：

**Playwrightとの繋がり**：
- Playwright（劇作家）といえばシェイクスピア
- シェイクスピアの四大悲劇の一つが「オセロ（Othello）」
- テスト自動化ツール「Playwright」を使う本システムにふさわしい名前

**テスト自動化への意味づけ**：
- **黒と白の反転**: テストの成功/失敗、実行済み/未実行の状態を表現
- **戦略的な思考**: テストカバレッジを戦略的に向上させる
- **盤面の可視化**: テストの実行状況を盤面のように可視化

### 1.2 目的

社内システムに対するE2Eテストの効率化とテストカバレッジの向上を目指し、**テスト観点リストに基づく体系的なテスト自動生成・実行システム**「Othello」を開発する。

**Othelloの役割**：
1. **テスト分析**: テスト観点リスト（23項目）に基づき、対象システムを体系的に分析
2. **テスト計画生成**: LLM（GPT-4o/Claude）を活用してテストケースを自動生成
3. **テスト実行**: Playwright MCP経由でブラウザを制御し、テストを実行
4. **結果分析**: 実行結果を分析し、カバレッジを算出
5. **自己修復**: 失敗したテストを分析し、バグかテスト記述ミスかを判断して修正
6. **イテレーション**: カバレッジ目標達成まで自動でループ

**Phase 9の特徴**：
- ✅ Playwright Agentsとは独立した実装
- ✅ プログラマティックに完全自動化
- ✅ テスト観点リストに基づく体系的アプローチ
- ✅ LLM活用による高度な分析・生成

### 1.3 背景

- 手動でのE2Eテスト実行には時間がかかる
- テストカバレッジの把握が困難
- 未実行のテストシナリオの洗い出しが属人化している
- **体系的なテスト観点に基づくテストが不足**
- **失敗したテストの原因分析に時間がかかる**

### 1.4 スコープ

**対象**: Webアプリケーション全般  
**実行環境**: ローカルPC（Windows/Mac/Linux）  
**フェーズ**: Phase 9（完全自動化版）

---

## 2. 機能要件

### 2.1 コマンドライン起動機能

**優先度**: 高

#### 2.1.1 基本コマンド

```bash
npx othello --url <対象URL>
```

**動作**：
1. Othello-Plannerが対象サイトを探索し、テスト観点リストに基づいてテスト分析
2. Othello-Generatorがテストケースから実行可能なスクリプトを生成
3. Playwright MCPを介してテストを実行
4. Analyzerが結果を分析してカバレッジを算出
5. Othello-Healerが失敗テストを修復
6. カバレッジ目標達成までループ継続

#### 2.1.2 オプション

| オプション | 説明 | 必須 | デフォルト値 |
|-----------|------|------|------------|
| `--url` | テスト対象のURL | ○ | - |
| `--max-iterations` | 最大ループ回数 | × | 10 |
| `--coverage-target` | 目標カバレッジ（%） | × | 80 |
| `--browser` | 使用ブラウザ（chromium/firefox/webkit） | × | chromium |
| `--output` | レポート出力先ディレクトリ | × | ./reports |
| `--config` | 設定ファイルのパス | × | ./config/default.json |
| `--test-aspects-csv` | テスト観点リストCSVのパス | × | ./config/test-ViewpointList.csv |
| `--auto-heal` | 失敗テスト自動修復モード | × | true |
| `--llm-provider` | LLMプロバイダ（openai/claude/mock） | × | openai |

#### 2.1.3 実行例

```bash
# 基本実行（カバレッジ80%達成まで自動ループ）
npx othello --url https://hotel-example-site.takeyaqa.dev/ja/reserve.html?plan-id=0

# カバレッジ目標90%で実行
npx othello --url https://example.com --coverage-target 90

# カスタムテスト観点リストを使用
npx othello --url https://example.com \
            --test-aspects-csv ./custom-ViewpointList.csv

# 完全自動モード（自動修復ON）
npx othello --url https://example.com --auto-heal --max-iterations 20
```

---

### 2.2 テスト観点リスト活用機能（Phase 9の核心機能）

**優先度**: 最高  
**実装状況**: ✅ **実装完了**（Othello-Planner）

#### 2.2.1 テスト観点リストの構造

テスト観点リストは以下の23項目で構成されます：

| No | 品質特性 | テストタイプ中分類 | テストタイプ小分類 | テスト観点 |
|----|---------|-------------------|-------------------|-----------|
| 1  | - | 表示（UI） | レイアウト/文言 | アイテムの配置/表示サイズは？ |
| 2  | - | 表示（UI） | エラー表示（正常系） | エラーメッセージはある？ |
| 3  | - | 入力 | 文字種 | 入力した文字種による仕様外の動作 |
| 4  | - | 入力 | 文字数（正常値） | 仕様通りの文字数が入力可能 |
| 5  | - | 入力 | 文字数（正常限界） | 上限/下限文字数が入力可能 |
| 6  | - | 入力 | 文字数（異常値） | 入力できない文字数でエラー |
| 7  | - | 入力 | 数値（正常値） | 仕様通りの数値が入力可能 |
| 8  | - | 入力 | 数値（異常値） | 入力できない数値でエラー |
| 9  | - | 入力 | 未入力 | 空白のまま実行した場合の動作 |
| 10 | - | 動作確認 | 単機能 | 各機能が仕様通りに動作 |
| 11 | - | 状態遷移 | - | イベント発生により状態が変わる |
| 12 | - | 状態遷移 | 経時変化 | イベント発生中や発生後の状態 |
| 13 | - | 画面遷移 | - | 画面切り替えとデータ保持 |
| 14 | - | 変更・反映設定保持 | 初期値 | 起動時の設定・表示 |
| 15 | - | 変更・反映設定保持 | 変更・反映 | 変更がどの機能に反映されるか |
| 16 | - | 変更・反映設定保持 | 設定保持 | 変更が終了後も保持される |
| 17 | - | 変更・反映設定保持 | キャンセル | キャンセル時の設定 |
| 18 | - | 機能組合せ | - | 複数因子の組み合わせ動作 |
| 19 | - | 同時実行 | 登録と参照 | DB登録と参照の同時実行 |
| 20 | - | 同時実行 | 複数アカウント | 別環境・同一アカウントからの操作 |
| 21 | - | 割込み | 複数アカウント別デバイス | 別デバイスからの操作 |
| 22 | - | 割込み | 登録と参照 | DB登録中の参照リクエスト |
| 23 | - | 排他処理 | 禁則 | 禁則条件に合致した操作 |

#### 2.2.2 各観点の分析項目

各テスト観点について、以下を自動生成します：

1. **対象の機能構造**: どの機能・画面・要素を対象とするか
2. **考慮すべき仕様の具体例**: テスト対象システム固有の具体的な仕様（3-5個）
3. **狙うバグ（欠陥仮定）**: この観点で見つけるべきバグの種類（2-3個）
4. **テストケース**: 具体的なテスト手順と期待結果（1-2ケース）

**出力形式**: JSON

```json
{
  "aspect_no": 1,
  "test_type": "表示（UI）",
  "test_category": "レイアウト/文言",
  "target_function": "ホテルプラン一覧ページのヘッダーとフッター",
  "specifications": [
    "ヘッダーにはホテルのロゴとナビゲーションリンクが含まれている",
    "フッターには著作権情報と利用規約へのリンクが含まれている",
    "全ての文言は日本語で表示されている"
  ],
  "target_bugs": [
    "ヘッダーやフッターの要素が正しく表示されない",
    "文言が誤っている、または表示されない",
    "レスポンシブデザインでのレイアウト崩れ"
  ],
  "priority": "P0",
  "test_cases": [
    {
      "case_id": "TC001",
      "title": "予約ページのヘッダーが正しく表示される",
      "steps": [
        "ブラウザで予約ページを開く",
        "ヘッダーの各要素を確認する"
      ],
      "expected_results": [
        "ホテルロゴが表示されている",
        "ナビゲーションメニューが表示されている"
      ]
    }
  ]
}
```

---

### 2.3 Othello-Planner（テスト分析・計画生成）

**優先度**: 最高  
**実装状況**: ✅ **実装完了**（2025年10月27日）

#### 2.3.1 責務

1. **CSV読み込み**: テスト観点リスト（23項目）をCSVから読み込む
2. **優先順位付け**: 未テスト観点を優先し、最大10個に限定
3. **LLM分析**: GPT-4o/Claudeを使用してシステムを分析
4. **テスト計画生成**: 各観点ごとに具体的なテストケースを生成

#### 2.3.2 入力

- 対象URL
- テスト観点リストCSV（23項目）
- 既存カバレッジ情報（2回目以降のイテレーション）
- イテレーション番号

#### 2.3.3 処理フロー

```
1. CSV を解析してテスト観点をロード
   └─ loadTestAspects(csvPath)
   
2. 優先順位付け（未テスト優先）
   └─ prioritizeAspects(aspects, existingCoverage)
   
3. LLM プロンプトを構築
   └─ buildAnalysisPrompt({ url, aspects, existingCoverage, iteration })
   
4. LLM に分析を依頼（GPT-4o/Claude）
   └─ analyzeWithLLM(options)
   
5. JSON レスポンスを解析
   └─ parseAnalysisResponse(content)
   
6. テストケースを抽出
   └─ extractTestCases(analysis)
   
7. Markdown レポートを生成
   └─ formatAsMarkdown(analysis)
```

#### 2.3.4 LLMプロンプト構造

**システムロール**:
```
あなたはテスト分析の専門家です。
```

**ユーザープロンプト**:
```
【対象URL】
{url}

【イテレーション】
{iteration}回目

【既存カバレッジ】
{existingCoverage ? JSON.stringify(existingCoverage) : 'なし'}

【テスト観点リスト】（優先度順）
No.1: 表示（UI） - レイアウト/文言
観点: アイテムの配置/表示サイズは？

No.2: 入力 - 文字種
観点: 入力した文字種による仕様外の動作
...（最大10観点）

【タスク】
各テスト観点について、以下を分析してください：

1. **対象の機能構造**: このシステムのどの画面・機能・要素が該当するか
2. **考慮すべき仕様の具体例**: このシステム固有の具体的な仕様（3-5個）
3. **狙うバグ**: この観点で見つけるべきバグの種類（2-3個）
4. **テストケース**: 具体的なテスト手順と期待結果（1-2ケース）

【出力形式】
JSON配列で出力してください：
[
  {
    "aspect_no": 1,
    "test_type": "表示（UI）",
    "test_category": "レイアウト/文言",
    "target_function": "...",
    "specifications": ["...", "..."],
    "target_bugs": ["...", "..."],
    "priority": "P0",
    "test_cases": [...]
  }
]
```

#### 2.3.5 出力

- **分析結果（JSON）**: 各観点の詳細分析
- **テストケース（配列）**: 実行可能なテストケース
- **Markdownレポート**: 人間が読める形式のレポート

#### 2.3.6 実装ファイル

- **本体**: `src/agents/othello-planner.js`
- **テスト**: `tests/othello-planner.test.js`（16/16 パス）
- **デモ**: `examples/demo-planner-custom.js`
- **ドキュメント**: `docs/OTHELLO_PLANNER_TECHNICAL_GUIDE.md`

---

### 2.4 Othello-Generator（テストスクリプト生成）

**優先度**: 最高  
**実装状況**: ❌ **未実装**（次のタスク）

#### 2.4.1 責務

1. **テストケース解釈**: Plannerが生成したテストケースを解釈
2. **DOM構造分析**: Snapshotから実際のDOM要素を特定
3. **スクリプト生成**: MCP互換の実行可能なスクリプト（JSON）を生成

#### 2.4.2 入力

- Plannerが生成したテストケース（JSON）
- 最新のSnapshot（DOM構造）
- 既存カバレッジ情報

#### 2.4.3 セレクタ戦略（優先順位）

1. **MCPのref**（最も信頼性が高い）
2. **data-testid属性**
3. **アクセシブルな名前**（role + name）
4. **セマンティックセレクタ**（button:has-text("Submit")）
5. **CSSセレクタ**（最後の手段）

#### 2.4.4 出力形式

```json
[
  {
    "test_case_id": "TC001",
    "aspect_no": 1,
    "instructions": [
      {
        "type": "navigate",
        "url": "https://example.com",
        "description": "Navigate to page"
      },
      {
        "type": "fill",
        "ref": "e48",
        "selector": "input[name='username']",
        "value": "山田太郎",
        "description": "Fill username"
      },
      {
        "type": "click",
        "ref": "e59",
        "selector": "button[type='submit']",
        "description": "Click submit"
      }
    ]
  }
]
```

---

### 2.5 Othello-Healer（失敗テスト自動修復）

**優先度**: 高  
**実装状況**: ❌ **未実装**

#### 2.5.1 責務

1. **失敗分析**: テスト失敗の原因を特定
2. **バグ判定**: 実際のバグかテスト記述ミスかを判断
3. **自動修復**: テスト記述ミスの場合は自動修正

#### 2.5.2 判定ロジック

- **is_bug: true** → バグレポート生成
- **is_bug: false** → テストスクリプト修正

---

### 2.6 Analyzer（カバレッジ分析）

**優先度**: 高  
**実装状況**: ❌ **未実装**

#### 2.6.1 責務

1. **観点カバレッジ算出**: 23観点のうち何観点がカバーされたか
2. **機能カバレッジ算出**: 特定された機能のうち何%がテストされたか
3. **未テスト領域特定**: 次のイテレーションで優先すべき観点を特定

---

### 2.7 Reporter（レポート生成）

**優先度**: 中  
**実装状況**: ❌ **未実装**

#### 2.7.1 出力形式

- **Markdown**: テスト計画書
- **JSON**: 実行結果
- **HTML**: 最終レポート

---

## 3. 非機能要件

### 3.1 パフォーマンス

| 項目 | 目標値 |
|------|--------|
| 1イテレーションの実行時間 | 5分以内 |
| LLM API呼び出し時間 | 20秒以内 |
| テストケース生成数 | 1観点あたり1-2ケース |

### 3.2 信頼性

- テスト失敗時の自動リトライ（最大3回）
- セッション切断時の自動再接続
- 実行履歴の永続化

### 3.3 保守性

- モジュール化されたアーキテクチャ
- 詳細なログ出力
- ユニットテストカバレッジ 80%以上

---

## 4. システム要件

### 4.1 実行環境

- **OS**: Windows 10/11, macOS 12+, Linux（Ubuntu 20.04+）
- **Node.js**: 18.x 以上
- **メモリ**: 4GB以上推奨

### 4.2 必須依存関係

- Playwright: ^1.40.0
- OpenAI SDK または Anthropic SDK
- Model Context Protocol (MCP)

### 4.3 API要件

- OpenAI API Key（GPT-4o/GPT-4o-mini）
- または Anthropic API Key（Claude 3.5 Sonnet）

---

## 5. 制約事項

### 5.1 技術的制約

- Playwright MCP が対応するブラウザに限定
- LLM API のレート制限に依存
- JavaScript実行可能なサイトのみ対応

### 5.2 スコープ外

- モバイルアプリのテスト
- API単体テスト
- パフォーマンステスト

---

## 6. 実装ステータス

### 6.1 完了コンポーネント

| コンポーネント | ステータス | 完了日 | テスト |
|--------------|----------|--------|--------|
| CSV Parser | ✅ 完了 | 2025-10-26 | 10/10 パス |
| LLM Factory | ✅ 完了 | 2025-10-26 | 7/7 パス |
| OpenAI Client | ✅ 完了 | 2025-10-26 | - |
| Othello-Planner | ✅ 完了 | 2025-10-27 | 16/16 パス |

### 6.2 未実装コンポーネント

| コンポーネント | 優先度 | 依存関係 |
|--------------|-------|---------|
| Othello-Generator | 最高 | Planner |
| Othello-Healer | 高 | Generator |
| Analyzer | 高 | Generator |
| Reporter | 中 | Analyzer |
| Orchestrator | 最高 | 全コンポーネント |

### 6.3 次のステップ

1. **Othello-Generator 実装** - テストケース→MCP命令変換
2. **Othello-Healer 実装** - 失敗テスト自動修復
3. **Analyzer 実装** - カバレッジ分析
4. **Reporter 実装** - レポート生成
5. **Orchestrator 実装** - 8ステップ統合ループ

---

**作成者**: Othello Development Team  
**レビュー**: 2025年10月28日  
**次回更新予定**: Othello-Generator 完了後
